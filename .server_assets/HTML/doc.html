<h1 id="mlserver">MLServer</h1>
<h2 id="what-is-mlserver-">What is MLServer?</h2>
<p>MLserver is a simple, easy to use webserver that allows for infinite flexibility</p>
<h2 id="how-to-install">How to install</h2>
<p>To use MLServer in your project, start out with downloading the <a href="https://raw.githubusercontent.com/Matthiasclee/MLServer/main/server.rb">main MLServer script</a>. You can either put it in your project folder and include it with <code>require &quot;./server.rb&quot;</code> or add it to a directory in you <code>$LOAD_PATH</code> array. MLServer will download all of its dependencies upon being run for the first time.</p>
<h2 id="how-to-use-mlserver">How to use MLServer</h2>
<p>Using MLServer is pretty straightforward. When your server receives a request, it calls the <code>path()</code> function and passes it the client that made the request, and a whole bunch of data that MLServer gathered about the request, including the path, headers, cookies, etc.</p>
<h3 id="getting-started">Getting Started</h3>
<p>To get started, define a <code>path()</code> function that takes in two variables, <code>client</code>, and <code>data</code>.</p>
<pre><code class="lang-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"./server.rb"</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">path</span><span class="hljs-params">(client, data)</span></span>

<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="sending-responses">Sending responses</h3>
<p>Inside of the <code>path()</code> function, your program will take in the data, and generate a response. You can send the http response back using the <code>response()</code> method.</p>
<p><code>resopnse()</code> takes 4 arguments: the client (passed to the <code>path()</code> function), the response code, the headers, and the actual data.</p>
<pre><code class="lang-rb"><span class="hljs-function"><span class="hljs-title">response</span><span class="hljs-params">(client, <span class="hljs-number">200</span>, [<span class="hljs-string">"content-type: text/html"</span>], <span class="hljs-string">"&lt;h1&gt;Hello World!&lt;/h1&gt;"</span>)</span></span>
</code></pre>
<p>Including that code above inside of <code>path()</code> will send back</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<p>to your browser, which will display &quot;Hello World!&quot; in large text when your server is visited in a web browser.</p>
<h3 id="redirects">Redirects</h3>
<p>MLServer also supports sending built in redirect responses so you don&#39;t need to make the whole thing yourself using the <code>redirect()</code> method.</p>
<pre><code class="lang-rb"><span class="hljs-function"><span class="hljs-title">redirect</span><span class="hljs-params">(client, <span class="hljs-string">"https://google.com"</span>)</span></span>
</code></pre>
<h3 id="error-responses">Error responses</h3>
<p>When the server encounters an internal error, error code 500 will automatically be sent to the client, but for other errors (404, 405) that are determined by your code, you need to call the error yourself. You could run </p>
<pre><code class="lang-rb"><span class="hljs-function"><span class="hljs-title">response</span><span class="hljs-params">(client, <span class="hljs-number">404</span>, [<span class="hljs-string">"content-type: text/html"</span>], <span class="hljs-string">"error 404"</span>)</span></span>
</code></pre>
<p>to send the 404 page, but there is a faster way.
MLServer comes with an <code>error()</code> method. With this, you can run</p>
<pre><code class="lang-rb"><span class="hljs-function"><span class="hljs-title">error</span><span class="hljs-params">(client, <span class="hljs-number">404</span>)</span></span>
</code></pre>
<p>to send back the error page, and you will get a default error page that resides in <code>&lt;MLServer.rb location&gt;/.server_assets/HTML</code>. You can modify these files to make custom 404 and 500 pages, or you could write your own error handler by defining <code>error()</code> yourself. 
<code>error()</code> takes a third argument too: error message. This error message only matters if it&#39;s a 500 error, or you want it to be outputted to the terminal, otherwise it doesn&#39;t matter.</p>
<h3 id="interpreting-data">Interpreting data</h3>
<p>You can of course also read the <code>data</code> variable passed to the <code>path()</code> function to generate a specific response. The <code>data</code> variable looks something like this:</p>
<pre><code class="lang-rb">{
    <span class="hljs-string">"request"</span> =&gt; <span class="hljs-string">"GET / HTTP/1.1\r\n"</span>, <span class="hljs-comment">#The request the client made to the server</span>
    <span class="hljs-string">"headers"</span> =&gt; { <span class="hljs-comment">#Hash of all headers given by the client</span>
        <span class="hljs-string">"Host"</span>=&gt;<span class="hljs-string">"127.0.0.1:5555"</span>, 
        <span class="hljs-string">"Connection"</span>=&gt;<span class="hljs-string">"keep-alive"</span>, 
        <span class="hljs-string">"sec-ch-ua-platform"</span>=&gt;<span class="hljs-string">"\"macOS\""</span>, 
        <span class="hljs-string">"User-Agent"</span>=&gt;<span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36"</span>, 
        <span class="hljs-string">"Accept"</span>=&gt;<span class="hljs-string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span>
    }, 
    <span class="hljs-string">"remote_ip"</span>=&gt;<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-comment">#The IP address of the client</span>
    <span class="hljs-string">"path"</span>=&gt;<span class="hljs-string">"/"</span>, <span class="hljs-comment">#The path the client is requesting</span>
    <span class="hljs-string">"get_params"</span>=&gt;{}, <span class="hljs-comment">#Get parameters (the ?a=b&amp;c=d at the end of a URL)</span>
    <span class="hljs-string">"method"</span>=&gt;<span class="hljs-string">"GET"</span>, <span class="hljs-comment">#The HTTP method the client is using</span>
    <span class="hljs-string">"data"</span>=&gt;<span class="hljs-string">""</span>, <span class="hljs-comment">#The data the client sent along (applicable with POST/PATCH and other HTTP methods)</span>
    <span class="hljs-string">"cookies"</span>=&gt;{ <span class="hljs-comment">#Cookies that can be accessed from that webpage</span>
        <span class="hljs-string">"example"</span> =&gt; <span class="hljs-string">"data"</span>
    }
}
</code></pre>
<p>With this data, we can make a better program that can give specific responses for specific pages and more.</p>
<pre><code class="lang-rb">require <span class="hljs-string">"./server.rb"</span>
def path(client, data)
    <span class="hljs-keyword">if</span> data[<span class="hljs-string">"method"</span>] == <span class="hljs-string">"GET"</span> #Only respond <span class="hljs-keyword">to</span> <span class="hljs-keyword">GET</span> requests
        <span class="hljs-keyword">if</span> data[<span class="hljs-string">"path"</span>] == <span class="hljs-string">"/"</span> #Only send <span class="hljs-built_in">response</span> <span class="hljs-keyword">if</span> the path <span class="hljs-keyword">is</span> <span class="hljs-string">"/"</span>
            <span class="hljs-built_in">response</span>(client, <span class="hljs-number">200</span>, [<span class="hljs-string">"content-type: text/html"</span>], <span class="hljs-string">"&lt;h1&gt;Hello World!&lt;/h1&gt;"</span>)
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">error</span>(client, <span class="hljs-number">404</span>) #<span class="hljs-keyword">Not</span> found <span class="hljs-keyword">error</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">error</span>(client, <span class="hljs-number">405</span>) #Invalid method <span class="hljs-keyword">error</span>    
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="starting-the-server">Starting the server</h3>
<p>Running any one of those code examples will do seemingly nothing. This is for a reason, as the server does not start until you start it. You start the server by putting <code>start()</code> at the bottom of the code.</p>
<pre><code class="lang-rb">require <span class="hljs-string">"./server.rb"</span>
def path(client, data)
    <span class="hljs-keyword">if</span> data[<span class="hljs-string">"method"</span>] == <span class="hljs-string">"GET"</span> #Only respond <span class="hljs-keyword">to</span> <span class="hljs-keyword">GET</span> requests
        <span class="hljs-keyword">if</span> data[<span class="hljs-string">"path"</span>] == <span class="hljs-string">"/"</span> #Only send <span class="hljs-built_in">response</span> <span class="hljs-keyword">if</span> the path <span class="hljs-keyword">is</span> <span class="hljs-string">"/"</span>
            <span class="hljs-built_in">response</span>(client, <span class="hljs-number">200</span>, [<span class="hljs-string">"content-type: text/html"</span>], <span class="hljs-string">"&lt;h1&gt;Hello World!&lt;/h1&gt;"</span>)
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">error</span>(client, <span class="hljs-number">404</span>) #<span class="hljs-keyword">Not</span> found <span class="hljs-keyword">error</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">error</span>(client, <span class="hljs-number">405</span>) #Invalid method <span class="hljs-keyword">error</span>    
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

start() #<span class="hljs-built_in">Server</span> will start listening <span class="hljs-keyword">for</span> requests
</code></pre>
<p>Your shell output will then look like this:</p>
<pre><code><span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">10</span> | <span class="hljs-type">MLServer</span> MLServer <span class="hljs-number">0.3</span><span class="hljs-number">.432</span>
<span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">10</span> | <span class="hljs-type">Checking</span> <span class="hljs-keyword">for</span> assets...
<span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">10</span> | <span class="hljs-type">Starting</span> the server...
<span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">10</span> | <span class="hljs-type">SSL</span> <span class="hljs-keyword">Mode</span>: false
<span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">10</span> | <span class="hljs-type">Server</span> listening on <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">80</span>
<span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">10</span> | <span class="hljs-type">Completed</span> <span class="hljs-built_in">in</span> <span class="hljs-number">0</span> seconds.
</code></pre><p>as the server actually has started. You now can visit <a href="http://localhost">localhost</a> in your web browser and see <code>Hello World!</code> in big font.</p>
<h3 id="mlserver-cli">MLServer CLI</h3>
<p>If you run <code>server.rb</code> or whatever file MLServer is saved as, you can use the MLServer CLI. The CLI is limited as of now. It has 4 commands:</p>
<pre><code><span class="hljs-keyword">exit</span>
start
ver
update_check
</code></pre><h4 id="exit">exit</h4>
<p>The <code>exit</code> command is used for exiting MLServer CLI.</p>
<h4 id="start">start</h4>
<p>The <code>start</code> command is used to start the server. 
It uses <code>main.rb</code> in whatever directory was passed as the main program.</p>
<h4 id="ver">ver</h4>
<p>The <code>ver</code> command prints the current MLServer version.</p>
<h4 id="update_check">update_check</h4>
<p>The <code>update_check</code> command checks for and updates MLServer.</p>
<h3 id="server-parameters">Server parameters</h3>
<p>You can start the server with parameters by passing a hash to the <code>start()</code> function. The supported parameters are as follows:</p>
<pre><code><span class="hljs-string">"host"</span> =&gt; <span class="hljs-built_in">string</span>
<span class="hljs-string">"bind-ipv4"</span> =&gt; <span class="hljs-built_in">string</span>
<span class="hljs-string">"bind-ipv6"</span> =&gt; <span class="hljs-built_in">string</span>
<span class="hljs-string">"ipv4"</span> =&gt; <span class="hljs-built_in">bool</span>
<span class="hljs-string">"ipv6"</span> =&gt; <span class="hljs-built_in">bool</span>
<span class="hljs-string">"max-clients"</span> =&gt; <span class="hljs-built_in">int</span>
<span class="hljs-string">"remove-trailing-slash"</span> =&gt; <span class="hljs-built_in">bool</span>
<span class="hljs-string">"always-add-content-length"</span> =&gt; <span class="hljs-built_in">bool</span>
<span class="hljs-string">"ssl"</span> =&gt; <span class="hljs-built_in">bool</span>
<span class="hljs-string">"ssl-key"</span> =&gt; <span class="hljs-built_in">string</span>
<span class="hljs-string">"ssl-cert"</span> =&gt; <span class="hljs-built_in">string</span>
<span class="hljs-string">"port"</span> =&gt; <span class="hljs-built_in">int</span>
</code></pre><h4 id="binding">Binding</h4>
<p>You can use server parameters to set the server&#39;s bind address(es) and port.
Using <code>bind-ipv4</code>, you can set the server&#39;s ipv4 listening address. 
Using <code>bind-ipv6</code>, you can set the server&#39;s ipv4 listening address.
Using <code>port</code>, you can set the server&#39;s listening port.
All bind addresses can be domain names too, including localhost.</p>
<pre><code class="lang-rb">start_params = {
    <span class="hljs-string">"bind-ipv4"</span> =&gt; <span class="hljs-string">"127.0.0.1"</span>,
    <span class="hljs-string">"bind-ipv6"</span> =&gt; <span class="hljs-string">"::1"</span>,
    <span class="hljs-string">"port"</span> =&gt; <span class="hljs-number">8080</span>
}

start(start_params)
</code></pre>
<h4 id="ipv4-and-ipv6">IPv4 and IPv6</h4>
<p>You can enable/disable use of the IPv4 and IPv6 protocols via the <code>ipv4</code> and <code>ipv6</code> parameters. By default only IPv4 is enabled.</p>
<pre><code class="lang-rb">start_params = {
    <span class="hljs-string">"ipv4"</span> =&gt; <span class="hljs-keyword">true</span>,
    <span class="hljs-string">"ipv6"</span> =&gt; <span class="hljs-keyword">true</span>
}

start(start_params)
</code></pre>
<h4 id="max-clients">Max Clients</h4>
<p>To limit server throttling, you can set the <code>max-clients</code> parameter to any positive integer (negitaves set no limit). This parameter limits the concurrent conenctions to the server at any given moment. (default -1)
NOTE: this is only useful for large scale deployments receiving lots of traffic.</p>
<pre><code class="lang-rb">start_params = {
    <span class="hljs-string">"max-clients"</span> =&gt; <span class="hljs-number">10</span>
}

<span class="hljs-function"><span class="hljs-title">start</span><span class="hljs-params">(start_params)</span></span>
</code></pre>
<h4 id="remove-trailing-slash">Remove Trailing Slash</h4>
<p>This parameter is pretty simple, when enabled, all requests to a non-root path that have an extra slash at the end are automatically redirected to the same URL, but with no extra slash. (default off)</p>
<pre><code class="lang-rb">start_params = {
    <span class="hljs-string">"remove-trailing-slash"</span> =&gt; true
}

<span class="hljs-function"><span class="hljs-title">start</span><span class="hljs-params">(start_params)</span></span>
</code></pre>
<h4 id="always-add-content-length">Always Add Content Length</h4>
<p>This parameter is pretty straightforward: it automatically adds the content-length header to all responses (default on)</p>
<pre><code class="lang-rb">start_params ={
    <span class="hljs-string">"always-add-content-length"</span> =&gt; false
}

<span class="hljs-function"><span class="hljs-title">start</span><span class="hljs-params">(start_params)</span></span>
</code></pre>
<h4 id="ssl">SSL</h4>
<p>MLServer, although still experimental <em>does</em> support use of SSL.
Enabling it is pretty straightfoward: you set <code>ssl</code> to true, and set <code>ssl-key</code> and <code>ssl-cert</code> to paths to ssl keys and certificates. </p>
<pre><code class="lang-rb">start_params = {
    <span class="hljs-string">"ssl"</span> =&gt; <span class="hljs-keyword">true</span>,
    <span class="hljs-string">"ssl-key"</span> =&gt; <span class="hljs-string">"./ssl/priv.key"</span>,
    <span class="hljs-string">"ssl-cert"</span> =&gt; <span class="hljs-string">"./.ssl/cert.crt"</span>
}
</code></pre>
<p>If done correctly, your shell output should look like this:</p>
<pre><code><span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">54</span> | <span class="hljs-type">MLServer</span> MLServer <span class="hljs-number">0.3</span><span class="hljs-number">.441</span>
<span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> | <span class="hljs-type">Checking</span> <span class="hljs-keyword">for</span> assets...
<span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> | <span class="hljs-type">WARN</span>: SSL is not fully supported yet, <span class="hljs-built_in">do</span> not deploy <span class="hljs-built_in">with</span> SSL.
<span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> | <span class="hljs-type">Starting</span> the server...
<span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> | <span class="hljs-type">SSL</span> <span class="hljs-keyword">Mode</span>: true
<span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> | <span class="hljs-type">Server</span> listening on <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">443</span>
<span class="hljs-number">15</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> | <span class="hljs-type">Completed</span> <span class="hljs-built_in">in</span> <span class="hljs-number">1</span> second.
</code></pre>